# Project: listing_bot_blockmedia
Telegram + Web Listing Monitor and Article Generator Bot

## 1. 프로젝트 정의

이 프로젝트는 업비트와 빗썸의 신규 상장 공지를 감지해 기사 초안과 텔레그램 배포 메시지를 자동 생성하고, 봇이 /on 상태인 채팅방들에 결과를 배포하는 텔레그램 봇이다.

입력 소스는 2개를 병렬로 사용한다.

1) 웹 공지 폴링  
- 업비트 공지 페이지를 주기적으로 폴링  
- 빗썸 공지 페이지를 주기적으로 폴링  
- 조건을 만족하는 신규 상장 공지를 감지하면 즉시 작업을 시작한다.

2) 텔레그램 메시지 트리거  
- 봇이 초대된 채팅방에서, 사용자가 상장 공지를 포워딩하거나 조건에 맞는 메시지를 올리면 작업을 시작한다.  
- 텔레그램 로그인(MTProto) 기반이 아니다. Bot API 기반으로, 누구나 봇을 초대하면 바로 사용 가능해야 한다.

중요 목표  
- “공지 중계 채널에 봇을 초대해야만 동작”하는 구조를 강제하지 않는다.  
- 웹 폴링이 1순위 정본 소스이며, 텔레그램 메시지 트리거는 백업 및 사용자 수동 입력 경로다.  
- 봇이 /on 상태가 아니면 아무것도 작동하지 않는다.

---

## 2. 봇 모드 및 동작 정책

지원 커맨드

- /on  
  - 해당 채팅방을 output 대상으로 활성화한다.  
  - 봇 전체가 /on 상태가 된다.  
  - /on 상태에서만 웹 폴링 및 텔레그램 트리거가 작동한다.

- /off  
  - 해당 채팅방을 output 대상에서 비활성화한다.  
  - 봇 전체가 /on 상태인 채팅방이 하나도 없으면, 웹 폴링 및 텔레그램 트리거 모두 중단한다.  
  - /off 상태라면 어떤 채팅방에서도 입력을 처리하지 않는다.

- /status  
  - 현재 봇 상태를 표시한다.  

핵심 규칙

- 봇은 “적어도 1개 이상의 채팅방이 /on” 상태일 때만 작동한다.  
- output은 “봇을 초대했고 /on 상태인 모든 채팅방”에 동일하게 발행된다.  
- 입력 트리거는 웹 폴링과 텔레그램 트리거가 병렬이며, 둘 중 어떤 경로로 들어와도 동일한 처리 파이프라인으로 합류한다.  
- 중복 방지는 notice_id 또는 (거래소 + 티커 + 공지 시각) 조합으로 수행한다.

---

## 3. 모니터링 대상

웹 폴링 대상

- 업비트 공지사항 목록 페이지  
  - https://upbit.com/service_center/notice

- 빗썸 공지사항 목록 페이지  
  - https://feed.bithumb.com/notice?category=9&page=1

텔레그램 트리거 대상

- 봇이 초대된 모든 채팅방 중, /on 상태인 채팅방  
- 사용자가 해당 방에 포워딩하거나, 조건에 맞는 메시지를 직접 올렸을 때 처리

---

## 4. 공지 필터링 규칙

처리 대상 유형

- 업비트  
  - “신규 거래지원 안내”에 해당하는 공지

- 빗썸  
  - “원화마켓 추가”에 해당하는 공지

제외 키워드 (제목 또는 본문에 포함되면 제외)

- 공지변경  
- 거래대기  
- 에어드랍  
- 이벤트  
- 리브랜딩  
- 마켓명 변경  
- 유의종목  
- 투자유의  
- 입출금 중단  
- 점검

---

## 5. 웹 폴링 파이프라인

목표  
- “새로 올라온 상장 공지”만 감지하고, 공지 URL에서 전문을 확보한다.

폴링 주기

- 기본 30~60초  
- 실패 시 백오프 적용  
  - 5초 → 10초 → 30초 → 60초 순으로 증가  
- 정상 복구 시 기본 주기로 복귀

감지 로직

1) 목록 페이지 폴링  
2) 최신 공지 리스트 파싱  
3) 제목 기반 1차 필터링 (신규 거래지원 안내 / 원화마켓 추가)  
4) 공지 ID 또는 URL에서 notice_id 추출  
5) DB에서 last_seen_notice_id 또는 processed_notices로 중복 여부 판단  
6) 신규 공지면 상세 페이지 URL로 본문 스크래핑 진행

---

## 6. 스크래핑 파이프라인

공지 상세 링크에서 본문 텍스트를 확보한다.

2단계 방식

1단계 정적 파싱  
- cheerio 사용  
- 본문 텍스트가 200자 이상이면 성공 처리

2단계 동적 렌더링  
- Playwright 사용  
- SPA 렌더 후 본문 추출  
- 실패 시 최대 2회 재시도

추출 품질 기준

- “헤더/푸터/메뉴 텍스트만 잔뜩”인 경우 실패로 간주  
- 본문 내 프로젝트명(티커) 패턴이 존재하는지 보조 검증 가능  
- 티커 추출은 본문에서 우선, 실패 시 텔레그램 메시지에서 fallback 가능

---

## 7. 생성 결과물

LLM 호출 결과는 2개 메시지로 구성된다.

1) 기사 본문 메시지 (article_message)  
- 상장 공지 전문을 기반으로 기사 초안을 생성한다.  
- 프롬프트는 거래소 유형에 따라 파일에서 로드한다.

2) 텔레그램 배포 메시지 (press_release_message)  
- 제목 + 첫 문장/둘째 문장 + 해시태그 + 링크 placeholder 구성  
- 거래소별 고정 이미지를 첨부한다.

이미지 파일

- upbit_listing_image.jpg  
- bithumb_listing_image.jpg

---

## 8. 프롬프트 파일 구조

프롬프트는 파일에서 로드한다.

- prompts/upbit_listing_prompt.txt  
- prompts/bithumb_listing_prompt.txt

선택 규칙

- UPBIT 유형 감지 → upbit_listing_prompt.txt  
- BITHUMB 유형 감지 → bithumb_listing_prompt.txt

---

## 9. Claude 응답 구조

응답은 JSON 형태를 강제한다.

예시

{
  "exchange": "UPBIT",
  "ticker": "SENT",
  "title": "업비트, ‘센티언트’ 원화·BTC·USDT 마켓 신규 상장… 29일 오후 5시30분 거래 시작",
  "article_message": "...",
  "press_release_message": "..."
}

검증 규칙

- exchange, ticker, title, article_message는 필수  
- press_release_message는 없으면 로컬 템플릿으로 생성 fallback 가능  
- ticker가 비어 있으면 실패 처리 또는 텔레그램 메시지에서 재추출 시도

---

## 10. 텔레그램 트리거 처리

봇이 초대된 채팅방에서 다음이 발생하면 처리한다.

- 사용자가 상장 공지 메시지를 포워딩  
- 사용자가 상장 공지 URL이 포함된 메시지를 직접 게시  
- 메시지 본문에 하이퍼링크(text_link)가 포함되어 URL이 텍스트에 나타나지 않는 경우, entities에서 URL을 추출해야 한다.

중요  
- 이 기능은 Bot API 기반이어야 한다.  
- 사용자가 봇을 초대하면 즉시 사용 가능해야 한다.  
- MTProto 로그인 기반(내 계정 자동화)은 사용하지 않는다.

---

## 11. 배포 정책

배포 대상

- DB에 등록된 채팅방 중 enabled = 1 인 모든 채팅방

배포 내용

- 기사 본문 메시지 1개  
- 텔레그램 배포 메시지 1개 + 거래소별 이미지

추가 배포

- 운영자 DM에도 동일한 결과물을 복사본으로 전송할 수 있다.  
  - 단, 운영자가 봇과 1:1 대화를 시작한 상태여야 한다.

---

## 12. 저장소 및 중복 방지

SQLite 저장

1) 채팅방 설정 테이블  
- chat_id  
- enabled (1/0)  
- updated_at

2) 처리된 공지 테이블 또는 last_seen 테이블  
- exchange  
- notice_id 또는 notice_url  
- ticker  
- processed_at

중복 방지 키 권장

- UPBIT: notice_id (id=5973 같은 값)  
- BITHUMB: 공지 고유 id 또는 url 파라미터  
- fallback: exchange + ticker + 공지 시각

---

## 13. 실패 처리

필터 불통과  
- 조용히 skip

스크래핑 실패  
- 재시도 후 실패 처리  
- 실패 로그 저장

LLM 실패  
- 재시도 후 실패 처리  
- 실패 로그 저장

전송 실패  
- 재시도  
- 일부 채팅방 전송 실패는 전체 실패로 간주하지 않고, 최소 1개 성공이면 성공 처리 가능

---

## 14. 구현 추가 항목

이 프로젝트는 기존 텔레그램 기반 처리 기능을 유지하면서, 아래 기능을 병렬로 추가한다. 기존 기능은 변경하지 않는다.

추가해야 할 모듈

- upbit_watcher.ts  
  - 업비트 공지 목록 폴링, 신규 상장 공지 감지, URL 전달

- bithumb_watcher.ts  
  - 빗썸 공지 목록 폴링, 신규 상장 공지 감지, URL 전달

- scheduler.ts  
  - 폴링 주기 관리, 백오프, 재시도 정책 관리

- storage/dedup  
  - notice_id 기반 처리 여부 기록 및 조회

- publisher(ON 채팅방 배포)  
  - enabled 채팅방 리스트 조회  
  - 기사 + PR 메시지 + 이미지 배포

통합 원칙

- 웹 watcher가 신규 공지를 감지하면 기존 processListingAnnouncement와 동일한 파이프라인으로 합류한다.  
  - 입력만 “웹에서 만든 메시지 형태”로 넣고, 이후 단계(필터, 스크래핑, LLM, 배포)는 동일하게 재사용한다.

- 텔레그램 트리거는 기존처럼 메시지에서 URL을 추출해 동일 파이프라인으로 합류한다.

---

## 15. Claude를 위한 사고 프레임

Claude는 이렇게 생각해야 한다.

- 상장 공지를 사람이 직접 처리하지 않아도 되게 만들려면 지금 무엇을 해야 하는가  
- 기다리지 말고 처리한다  
- 출력은 바로 배포 가능한 완성도여야 한다  
- 불필요한 완충 표현을 피하고 실무 톤을 유지한다
