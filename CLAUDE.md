# CLAUDE.md
Project: listing_bot_blockmedia (Telegram Listing Monitor + Blockmedia Article Generator)

## 1. 프로젝트 정의
이 프로젝트는 텔레그램 공지 채널을 모니터링해서, 업비트/빗썸의 ‘신규 상장’ 공지 중 특정 조건을 만족하는 경우에만 블록미디어 기사 초안을 자동 생성하고, 이어서 텔레그램 배포용 보도자료 메시지(사진 포함)를 자동 생성하는 텔레그램 봇이다.

핵심 목표
- 상장 공지 발생 직후 자동 기사화
- 블록미디어 기사 스타일을 프롬프트 파일로 강제
- 한 공지에 대해 메시지 2개 생성
  1) 기사 본문(봇 메시지로 전달)
  2) 텔레그램 보도자료 메시지(사진 + 요약 + 티커 해시 + 기사 보기 문구)

## 2. 범위와 비범위
포함
- 텔레그램 채팅방 모니터링
  - 새우잡이어선 공지방: -1001379897604
- 공지 메시지에서 링크 추출 → 링크로 들어가 공지 전문 텍스트 확보
- 조건 필터링
  - 업비트(Upbit) 공지 '코인' 신규 거래 지원 안내
  - 빗썸(Bithumb) 원화마켓 추가
  - 공지변경/거래대기/에어드랍 등 제외
  - “새로운 코인에 대한 첫 게시글”만 처리
- 기사 생성 프롬프트 분리
  - 업비트: prompts/upbit_listing prompt.txt
  - 빗썸: prompts/bithumb_listing prompt.txt
- 텔레그램 배포 문구 생성
  - 업비트: upbit_telegram_press_release 형식
  - 빗썸: bithumb_telegram_press_release 형식
- 채팅방별 기능 on/off
  - 봇이 초대된 채팅방마다 on/off 상태 유지
  - off면 공지 감지/생성/전송 모두 중단

비범위(초기)
- 자동으로 블록미디어 CMS 업로드
- 기사 링크 자동 수집(일단 링크 추후 삽입 문구 유지)
- 이미지 생성(지정 파일 사용만)
  - 업비트: upbit_listing_image.jpg
  - 빗썸: bithumb_listing_image.jpg
- 다중 플랫폼(슬랙 등)

## 3. Claude의 역할(운영 원칙)
Claude는 다음 원칙으로만 동작한다.
- “기사 양식”은 프롬프트 파일 내용을 절대 우회하지 않는다.
- 입력으로 주어지는 “복사한 공지사항 전문”을 기반으로만 작성한다.
- 추측/각색/추가 정보 삽입을 하지 않는다.
  - 공지 전문에 없는 디테일을 임의로 추가하지 않는다.
- 출력은 항상 2개다.
  1) article_message: 블록미디어 기사 본문
  2) press_release_message: 텔레그램 보도자료 메시지(정해진 포맷)

## 4. 공지 필터링 규칙(중요)
텔레그램 메시지가 아래 조건을 모두 만족해야 처리한다.

1) 공지 타입
- 메시지 텍스트에 다음 중 하나가 포함되어야 한다.
  - "업비트(Upbit) 공지 신규 거래 지원 안내"
  - "빗썸(Bithumb) 원화마켓 추가"

2) 제외 키워드
- 메시지 텍스트에 다음이 포함되면 제외한다(대소문자/공백 변형 포함).
  - 공지변경
  - 거래대기
  - 에어드랍
  - 이벤트
  - 리브랜딩
  - 마켓명 변경
  - 유의종목
  - 투자유의
  - 입출금 일시 중단
  - 점검

3) 동일 코인 중복 방지(“첫 게시글만”)
- 코인 티커(symbol) 기준으로 첫 공지만 처리한다.
- 같은 티커가 다시 등장하면 skip한다.
- 영속 저장이 필요하다(봇 재시작 후에도 유지).
- 저장 키는 다음을 권장한다.
  - exchange(UPBIT/BITHUMB) + ":" + ticker
- 단, 상장 네트워크/마켓 조합이 달라도 “첫 공지”만 원칙이면 동일 키로 처리한다.

4) 공지 전문 확보 (2단계 스크래핑 파이프라인)
- 텔레그램 메시지에 포함된 링크로 접속한다.
- 해당 공지 페이지의 전문 텍스트를 추출한다.
- **업비트는 SPA 구조**이므로 기본적으로 Playwright(동적 렌더링) 사용
- **빗썸 등 정적 페이지**는 cheerio(정적 파싱) 먼저 시도 → 실패 시 Playwright
- 추출 텍스트가 비어있거나 너무 짧으면(예: 200자 미만) 실패 처리하고 재시도(최대 2회).

## 5. 생성물 정의
Claude 호출 결과는 항상 아래 2개 문자열을 반환한다.

1) article_message
- 업비트/빗썸 각각 해당 프롬프트 파일(upbit_listing prompt.txt 또는 bithumb_listing prompt.txt)에 맞춘 블록미디어 기사 본문
- 입력은 반드시 “복사한 공지사항 전문”을 그대로 포함해서 작성 근거로 삼는다.

2) press_release_message
- 형식(업비트/빗썸 동일 구조)
  - 사진(전송 시 파일 첨부)
  - 제목(기사 제목과 동일)
  - [블록미디어 ***] 기사 첫 문장 + 두 번째 문장
  - #TICKER
  - 기사 보기 👉 링크 추후 삽입
- 업비트는 upbit_listing_image.jpg 첨부
- 빗썸은 bithumb_listing_image.jpg 첨부

주의
- press_release_message의 “기사 첫 문장과 두 번째 문장”은 article_message에서 그대로 가져온다.
- 티커는 공지에서 확정된 심볼을 사용한다.
- 링크는 실제 업로드 전이므로 고정 문구 “링크 추후 삽입”을 유지한다.

## 6. 프롬프트 운용 방식
prompts 폴더에 프롬프트를 분리한다.
- prompts/upbit_listing prompt.txt
- prompts/bithumb_listing prompt.txt

listing_bot.py(또는 TS의 listing_bot.ts)에 내장된 프롬프트는 제거하고,
상장 분류 결과에 따라 위 파일을 로드해 사용한다.

Claude 호출 시 구성
- system: 고정 시스템 규칙(추측 금지, 두 개 출력 강제, JSON 스키마 강제)
- user:
  - 선택된 프롬프트 파일 내용 전문
  - 복사한 공지사항 전문(스크래핑 결과)

## 7. 출력 포맷(Claude 응답 스키마)
Claude는 반드시 JSON으로만 응답한다(추가 텍스트 금지).

{
  "exchange": "UPBIT" | "BITHUMB",
  "ticker": "XAUT",
  "title": "기사 제목",
  "article_message": "기사 본문 전체",
  "press_release_message": "텔레그램 배포 문구"
}

## 8. 온/오프 커맨드(텔레그램)
봇이 초대된 채팅방에서 다음 커맨드를 지원한다.
- /on
- /off
- /status

권한 정책(권장)
- 그룹/채널에서는 관리자만 /on /off 가능
- /status는 누구나 가능

저장 정책
- chat_id 단위로 enabled 상태를 DB에 저장한다.
- 기본값은 off(권장) 또는 on(운영 선택).
- 운영 편의상: 공지방(-1001379897604)은 강제 on(선택).

## 9. 실패 처리 원칙
- 공지 전문 스크래핑 실패: 2회 재시도 후 실패 로그 남기고 종료
- Claude API 실패: 2회 재시도(지수 백오프) 후 실패 처리
- 중복 공지: 조용히 skip(메시지 전송 없음)
- 부분 성공 금지: article_message 생성 성공했는데 press_release_message 실패하면 전체 실패로 재시도한다.

## 10. 스크래핑 전략: 2단계 파이프라인 (Upbit SPA 대응)

### 문제
- 업비트 공지 페이지는 **SPA(Single Page Application)** 구조다.
- 최초 HTML은 껍데기이며 본문은 JavaScript로 동적으로 로드된다.
- cheerio는 정적 HTML만 파싱하므로 본문 추출 결과가 **0글자**가 될 수 있다.

### 해결: 2단계 스크래핑 파이프라인

#### 1단계: Static Extractor (cheerio)
- **대상**: 빗썸 등 정적 HTML 페이지, 또는 업비트가 예외적으로 SSR을 제공하는 경우
- **성공 조건**: 본문 텍스트 200자 이상
- **장점**: 빠르고 가볍다

#### 2단계: Dynamic Renderer (Playwright)
- **대상**: 업비트 공지(기본), 또는 static extractor 실패 시 폴백
- 페이지를 실제로 **렌더링한 뒤 DOM에서 본문을 추출**한다.
- **Playwright(Chromium headless)** 사용

### 추출 목표
- "안녕하세요… 신규 디지털 자산 거래지원을…" 이하 **공지 본문 전체**를 사람이 복사해 붙여넣을 수 있는 수준의 텍스트로 확보한다.
- 표(디지털 자산/마켓/네트워크/시간)는 텍스트 형태로라도 포함되도록 한다.

### Dynamic Renderer 구현 포인트

#### 브라우저 관리
- 브라우저는 **프로세스 생명주기 동안 1회만 띄우고 재사용**한다 (싱글톤).
- 페이지 컨텍스트만 매번 새로 생성하고 종료한다.

#### 리소스 최적화
- **요청 차단**:
  - `image`, `media`, `font`는 차단
  - `stylesheet`는 허용 (DOM 구성에 필요할 수 있음)
- User-Agent 지정

#### 대기 전략
- `domcontentloaded` 후 본문 컨테이너가 등장할 때까지 `waitForSelector`
- 또는 네트워크 안정화 + 추가 대기(짧게) 조합
- **타임아웃**: 10~15초 기본

#### 업비트 전용 셀렉터 전략
1. **1차**: 본문 컨테이너 후보 셀렉터를 여러 개 시도
   - `.notice-view-content`, `.notice-content`, `.view-content`, `article`, `main`
2. **2차**: 실패하면 텍스트 밀도 높은 블록을 찾는 휴리스틱 적용
   - `div`, `section`, `article`, `main` 중 `textContent` 길이가 가장 긴 요소 선택

#### 추출 결과 검증
- 텍스트 길이 **200자 미만이면 실패**
- "신규 디지털 자산 거래지원", "거래", "지원" 같은 핵심 문구가 없으면 경고

#### 디버깅
- 실패 시 렌더된 HTML을 파일로 저장: `data/debug/upbit_notice_<timestamp>.html`

### 재시도 정책
- 스크래핑 실패 시 **최대 2회 재시도** (retry layer에서 처리)
- 1회 실패: 500ms 대기 후 재시도
- 2회 실패: 2000ms 대기 후 재시도
- 2회 모두 실패 시 전체 실패 처리

## 11. 개발 체크리스트(최소)
- 텔레그램 업데이트 수신(폴링 또는 웹훅)
- 공지 링크 추출/스크래핑 (2단계 파이프라인)
- 분류(UPBIT/BITHUMB + 제외 규칙)
- 중복 방지 저장소
- 프롬프트 파일 로더
- Claude 호출 및 JSON 파싱/검증
- 메시지 2개 전송(기사 본문, 보도자료+사진)
- 채팅방 on/off 스토리지 및 커맨드 핸들러
